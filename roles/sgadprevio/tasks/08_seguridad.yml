# 08_seguridad.yml - PKI, sudoers, security checks

    - name: pkis pem x509
      shell: find  /etc/pki/ /etc/pki/ca-trust/ -name "*.pem" -exec sh -c 'echo dbd{}dbd && openssl x509 -in {} -noout -text ' \;| sed 's/dbd/<br>/g'
      register: pkix509
      ignore_errors: True

    - name: pkis pem x509
      shell: find  /etc/pki/ /etc/pki/ca-trust/ -name "*.crt" -exec sh -c 'echo dbd{}dbd && openssl x509 -in {} -noout -text ' \;| sed 's/dbd/<br>/g'
      register: pkiCRTx509
      ignore_errors: True

    - name: usuarios de sistema
      shell: echo -e "$(awk -F':' '{print $1}' /etc/passwd|while read NODE RESTO ; do id $NODE;done)"
      register: homeusers

    - name: sudo
      shell: visudo -c | grep -i sudo && echo '<hr>' && grep wheel /etc/group
      register: sudoers
      ignore_errors: True


    - name: Leer fichero /etc/fstab
      ansible.builtin.slurp:
        src: /etc/fstab
      register: slurp_etc_fstab

    - name: Preparar salida de fstab para reporte
      ansible.builtin.set_fact:
        etcfstab:
          stdout: "{{ slurp_etc_fstab.content | b64decode }}"

    - name: Comprobar directorio de configuracion de la aplicacion
      ansible.builtin.stat:
        path: "{{ app_config_path }}"
      register: app_config_dir_stat

    - name: Listar ficheros de configuracion de la aplicacion
      ansible.builtin.command:
        cmd: "ls -ltra {{ app_config_path }}"
      register: etcconfigini
      when: app_config_dir_stat.stat.exists and app_config_dir_stat.stat.isdir
      changed_when: false
      ignore_errors: True # Ignorar si ls falla por permisos, etc. La plantilla lo gestionará.

    - name: configuracion de dominio
      shell: realm list |grep ':' || echo -e '<p style=color:red;>⚠️ ⚠️ REVISAR_⚠️ ⚠️ SIN CONFIGURACIÓN REALMD _REVISAR</p>'
      register: realmlist

    - name: Fichero config dominio
      command: cat -A /etc/sssd/sssd.conf
      register: fichsssd
      ignore_errors: True

